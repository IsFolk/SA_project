<!DOCTYPE html>
<html>
	<head>
		<title>OWL MY CLASS</title>
		<meta charset="utf-8">
		<base href="">
		<link rel="icon" type="image/png" href="">
		<link href="" type="text/css" rel="stylesheet">
		<link href="css_files/general.css" type="text/css" rel="stylesheet">
		<link href="css_files/.css" type="text/css" rel="stylesheet">
		<script src="statics/js/jquery-3.4.1.min.js" crossorigin="anonymous"></script>
	</head>
	<body>
		<!--畫面最上方的橫條navbar-->
		<nav>
			<div class="container">
				<div class="navbar-header">
					<img src="" alt="logo">
					<span class="text">OWL MY CLASS</span>
				</div>
				<div class="navbar-collapse">
					<ul class="navbar-right">
						<li>
							<div class="homebtn">
								<a href="#"><span class="text">我的主頁</span></a>
							</div>
						</li>
						<li class="dropdown-btn">
							<a href="#" tabindex="0"><img src="" alt="img"></a>
							<ul class="dropdown-menu">
								<li>
									<a href="#"><span class="text">個人資訊</span></a>
								</li>
								<li>
									<a href="#"><span class="text">登出</span></a>		
								</li>
							</ul>
						</li>
					</ul>
				</div>
			</div>
		</nav>

		<!--橫幅-->
		<div class="banner">
			<div class="container">
				<img src="" alt="img">
					<span class="banner-name course-name text-bold"></span>
					<span class="banner-extInfo course-code"></span>
			</div>
		</div>

		<!--下半部分-->
		<div class="lowerhalf">
			<div class="container">
				<!--左下的選單-->
				<div class="sidebar">
					<div class="professor">
						<span class="text-bold">教授:</span><span class="text-bold course-professor"></span>
					</div>
					<ul class="sidebar-menu">
						<li>
							<a href="../info/info.html"><span class="text">課程資訊</span></a>
						</li>
						<li class="currentpage">
							<a href="board.html"><span class="text">課程公告</span></a>
						</li>
						<li>
							<a href="../textbook/textbookList.html"><span class="text">課程教材</span></a>
						</li>
						<li>
							<a href="../homework/homeworkList.html"><span class="text">作業</span></a>
						</li>
						<li>
							<a href="../test/testList.html"><span class="text">測驗</span></a>
						</li>
					</ul>
				</div>
				<!--右下區域-->
				<div class="content-right">
					<div class="content-right-title">
						<span class="text-bold">修改公告</span>
					</div>
					<div class="hr"></div>
					<form>
						<table class="form-tbl">
							<tbody>
								<tr>
									<td class="tr-title"><span class="text-bold">標題</span></td>
									<td><textarea class="round-border blue-border board-name" name="title" type="text" placeholder="標題為必填，限50字" maxlength="50"></textarea></td>
								</tr>
								<tr>
									<td class="tr-title"><span class="text-bold">內容</span></td>
									<td><textarea class="round-border blue-border board-detail" name="description" placeholder="內文與檔案須至少擇一上傳" rows="10"></textarea></td>
								</tr>
								<tr>
									<td><span class="text-bold">附件</span></td>
									<td>
										<span class="board--attachmentName"></span>
										<form method="post" action="board(try).html" enctype="mutlipart/form-data">
										<br>
										<input type="file" id="ajaxfile" class="cursor-pointer">
										</form>
									</td>
								</tr>
							</tbody>
						</table>
						<input type="button" onclick="window.location=document.referrer;" id="submit" class="submit-btn round-border cursor-pointer" value="確認修改">
					</form>
				</div>
			</div>
		</div>
		
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
		<script src="js_files/general.js"></script>
		<script>
		////////////////把資料塞進table//////////////
		        var url_string = window.location.href;                
                var url = new URL(url_string);
                console.log(url);
                var courseid = url.searchParams.get("CourseId");
                var boardid = url.searchParams.get("BoardId");
                var sql_num = 0;           

                function updateMember(id) {
	
                    var name = $(".board-name").val();
                    var detail = $(".board-detail").val();
					console.log(ajaxfile.files[0]);
                    var attachment = "";
                    

					console.log(attachment);
					if(ajaxfile.files[0] != null){
						attachment =  ajaxfile.files[0]["name"];
					}
					

                        // 將資料組成JSON格式
                        var data_object = {
                        	"BoardId": id,
                        	"CourseId": courseid,
                            "BoardName": name,
                            "BoardDetails": detail,
                            "Attachment": attachment
                        };

                        // 將JSON格式轉換成字串
                        var data_string = JSON.stringify(data_object);
                        
                        console.log(data_string);
						
                        
                        var PUT = false;
                        var POST = false;
                        
                        // 發出POST的PUT請求
                        $.ajax({
                                type: "PUT",
                                url: "api/BoardController",
                                data: data_string,
                                crossDomain: true,
                                cache: false,
                                dataType: 'json',
                                timeout: 5000,
                                success: function (response) {
                                    $('#flashMessage').html(response.message);
                                    $('#flashMessage').show();
                                    if(response.status == 200){
                                    	PUT = true;
                                        console.log("PUT OK");
                                        alert("PUT OK");
                                    }
                                },
                                error: function () {
                                	console.log("PUT ERROR");
                                    alert("無法連線到伺服器！");
                                }
                        });
                        
                    	let formData = new FormData();
                    	formData.append(boardid, ajaxfile.files[0]);
                    	console.log(ajaxfile.files[0] == null);
                    	
                    	if(ajaxfile.files[0]!=null){
                    		$.ajax({
                                type: "POST",
                                url: "api/UploadController",
                                data: formData,
                                processData : false, 
                                contentType : false,
                                crossDomain: true,
                                cache: false,
                                timeout: 60000,
                                success: function (response) {
                                    //$('#flashMessage').html(response.message);
                                    //$('#flashMessage').show();
                                    console.log(response);
                                    //alert('stop');
                                    if(response.status == 200){
                                        //updateSQLTable(response.response);
                                        console.log("POST success");
                                        alert("上傳成功");
                                    }
                                },
                                error: function (XMLHttpRequest) {
                                	console.log("POST ERROR");
                                	console.log(XMLHttpRequest.status);
                                	console.log(XMLHttpRequest.readyState);
                                    alert("無法連線到伺服器！");
                                }
                        	});
                    		POST = true;
                    	}
                    
                    }
        
                
                function getMember() {
                    $.ajax({
                        type: "GET",
                        url: "api/BoardController",
                        crossDomain: true,
                        data: "BoardId=" + boardid,
                        cache: false,
                        dataType: 'json',
                        timeout: 5000,
                        success: function (response) {
                            if(response.status == 200){
                            	//console.log(response);
                            	//document.getElementById('manager_name').value = response['response']['data'][0]['ManagerName'];
                            	//console.log(response['response']['data'][0]['ManagerName']);
                            	//document.getElementById('manager_email').value = response['response']['data'][0]['ManagerEmail'];
                            	//document.getElementById('manager_password').value = response['response']['data'][0]['Password'];
                            	//document.getElementById('manager_login_times').value = response['response']['data'][0]['login_times'];
                				
                            	var testData = {
                						id: response['response']['data'][0]['BoardId'],
                						name: response['response']['data'][0]['BoardName'], 
                						updateDate: response['response']['data'][0]['UpdateTime'], 
                						detail: response['response']['data'][0]['BoardDetails'],
                						attachmentName: response['response']['data'][0]['Attachment']
                					};
                				$(".board-name").text(testData.name);
                				$(".board-detail").text(testData.detail);
                				$(".board--attachmentName").text(testData.attachmentName);
                            }
                            console.log(response);
                        },
                        error: function () {
                            alert("無法連線到伺服器！");
                        }
                    });
                }
				
                
                $('#submit').click(function() {
                	console.log(boardid);
                	updateMember(boardid);
                	
                	//document.getElementById("submit").href = "addBoard.html?CourseId="+courseid;
                	//location.href='https://google.com'
                    
                });
				
                $(document).ready(function() {
                	// 發出GET的AJAX請求取得原本該會員的資料
                 	$("#sql_log > tbody").empty();
                    getMember();
                }
                )
		</script>
	</body>
</html>