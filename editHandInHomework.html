<!DOCTYPE html>
<html>
	<head>
		<title>OWL MY CLASS</title>
		<meta charset="utf-8">
		<base href="">
		<link rel="icon" type="image/png" href="">
		<link href="" type="text/css" rel="stylesheet">
		<link href="statics/css/general.css" type="text/css" rel="stylesheet">
		<link href="statics/css/handInHomework.css" type="text/css" rel="stylesheet">
	</head>
	<body>
		<!--畫面最上方的橫條navbar-->
		<nav>
			<div class="container">
				<div class="navbar-header">
					<img src="" alt="logo">
					<span class="text">OWL MY CLASS</span>
				</div>
				<div class="navbar-collapse">
					<ul class="navbar-right">
						<li>
							<div class="homebtn">
								<a href="#"><span class="text">我的主頁</span></a>
							</div>
						</li>
						<li class="dropdown-btn">
							<a href="#" tabindex="0"><img src="" alt="img"></a>
							<ul class="dropdown-menu">
								<li>
									<a href="#"><span class="text">個人資訊</span></a>
								</li>
								<li>
									<a href="#"><span class="text">登出</span></a>		
								</li>
							</ul>
						</li>
					</ul>
				</div>
			</div>
		</nav>
		<!--橫幅-->
		<div class="banner">
			<div class="container">
				<img src="" alt="img">
					<span class="banner-name course-name text-bold"></span>
					<span class="banner-extInfo course-code"></span>
			</div>
		</div>
		<!--下半部分-->
		<div class="lowerhalf">
			<div class="container">
				<!--左下的選單-->
				<div class="sidebar">
					<div class="professor">
						<span class="text-bold">教授:</span><span class="text-bold course-professor"></span>
					</div>
					<ul class="sidebar-menu" id="sidebar_menu">
					</ul>
				</div>
				<!--右下區域-->
				<div class="content-right">
					<div class="content-right-title">
						<span class="text-bold homework-name"></span>
					</div>
					<div class="hr"></div>
					<form>
						<table class="form-tbl">
							<tbody id="hd_hw">

							</tbody>
						</table>
						<br><br><br>
						<input id="submit" type="submit" class="submit-btn round-border cursor-pointer" value="確認繳交">
					</form>
				</div>
			</div>
		</div>
		
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
		<script src="statics/js/general.js"></script>
		<script>
$(".homework-name").text("作業一");
$(".start-time").text("time");
$(".end-time").text("time");
$(".handin-hw-text").text("繳交作業內容");
$(".handin-hw-attachmentName").text("HWattachment.pdf");

var url_string = window.location.href;
var url = new URL(url_string);
var id = url.searchParams.get("id");
var HwId = url.searchParams.get("HwId");
  function getCourseInfo() {
	  $.ajax({
          type: "GET",
          url: "HomeworkController",
          //data: "CourseId=" + id + "&HwId=" + HwId,
          data: "CourseId=" + id,
          crossDomain: true,
          cache: false,
          dataType: 'json',
          timeout: 5000,
          success: function (response) {
              if(response.status == 200){
            	  updateHTML();
              }
          },
          error: function () {
              alert("無法連線到伺服器！");
          }
    });
  }

  updateMenu(id); 
  getCourseInfo();


function updateMenu(id) {
     $("#sidebar_menu").empty();
     var table_html = '';     
     table_html += '<li class="currentpage">';
     table_html += '<a href="info.html?id='+ id + '">' + '<span class="text">' + "課程資訊" + '</span>' + '</a>';
     table_html += '</li>';
     table_html += '<li>';
     table_html += '<a href="board.html?id='+ id + '">' + '<span class="text">' + "課程公告" + '</span>' + '</a>';
     table_html += '</li>';
     table_html += '<li>';
     table_html += '<a href="textbookList.html?id='+ id + '">' + '<span class="text">' + "課程教材" + '</span>' + '</a>';
     table_html += '</li>';
     table_html += '<li>';
     table_html += '<a href="homeworkList.html?id='+ id + '">' + '<span class="text">' + "作業" + '</span>' + '</a>';
     table_html += '</li>';
     table_html += '<li>';
     table_html += '<a href="testList.html?id='+ id + '">' + '<span class="text">' + "測驗" + '</span>' + '</a>';
     table_html += '</li>';
    
     $("#sidebar_menu").append(table_html);
}

function updateHTML(data) {
    $("#hd_hw").empty();
    var table_html = '';
    $.each(data, function(key, value) {
        table_html += '<tr>';
        table_html += '<td class="tr-title">' + "開放時間" + '</td>';
        table_html += '<td>' +''+'<span class="start-time">'+ value['OpeningTime'] + '</span>' + "~" +'<span class="end-time">'+ value['EndingTime'] + '</span>' + '</td>';
        table_html += '</tr>';
        table_html += '<tr>';
        table_html += '<td class="tr-title">' + "作業說明" + '</td>';
        table_html += '<td>' + '<div class="homework-detail">' + value['HwDetail'] + '</div>' + '</td>';
        table_html += '</tr>';
        table_html += '<tr>';
        table_html += '<td class="tr-title">' + "繳交內容" + '</td>';
        table_html += '<td>' + '<textarea id="HwHandInDetail" class="round-border blue-border handin-hw-text" name ="" rows="6">' + '</textarea>' + '</td>';
        table_html += '</tr>';
        table_html += '<tr>';
        table_html += '<td class="tr-title">' + "附件" + '</td>';
        table_html += '<td>' + '<input id="ajaxfile" type="file" class="cursor-pointer">' + '</td>';
        table_html += '</tr>';
   })

    $("#hd_hw").append(table_html);
}

////	按下確認繳交後送出資料 ////
$('#submit').click(function() {
	//alert('submit');
	uploadFile();
	updateHandIn();
});

//		上傳檔案到本地端		//
async function uploadFile() {
    let formData = new FormData(); 
    formData.append("file", ajaxfile.files[0]);
    await fetch('api/HwUploadController', {
      method: "POST", 
      body: formData
    }); 
    alert("成功新增檔案！");
  }

function updateHandIn() {
    //var hwId = url.searchParams.get("HwId");
    //var id = url.searchParams.get("id");
    var hwHandInDetail = $('#HwHandInDetail').val();
        // 將資料組成JSON格式
        var data_object = {
           	//"StudentId": id,	//不知道student是誰
           	"CourseId": id,
            "HwId": HwId,
            "HwHandInDetail": hwHandInDetail
        };

        // 將JSON格式轉換成字串
        var data_string = JSON.stringify(data_object);

        // 發出POST的PUT請求
        $.ajax({
                type: "PUT",
                url: "HandInHwController",
                data: data_string,
                crossDomain: true,
                cache: false,
                dataType: 'json',
                timeout: 5000,
                success: function (response) {
                    if(response.status == 200){
                       alert("成功新增");
                       document.location.href = "handInHomework.html?id=" + id + "&HwId=" + hwId;	//try
                        //getMember();
                    }
                },
                error: function () {
                    alert("無法連線到伺服器！");
                }
        });
    
}

		</script>
	</body>
</html>