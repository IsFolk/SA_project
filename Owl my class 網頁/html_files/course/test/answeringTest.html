<!DOCTYPE html>
<html>
	<head>
		<title>OWL MY CLASS</title>
		<meta charset="utf-8">
		<base href="">
		<link rel="icon" type="image/png" href="">
		<link href="" type="text/css" rel="stylesheet">
		<link href="../../../css_files/general.css" type="text/css" rel="stylesheet">
		
	</head>
	<body>
		<!--畫面最上方的橫條navbar-->
		<nav>
			<div class="container">
				<div class="navbar-header">
					<img src="" alt="logo">
					<span class="text">OWL MY CLASS</span>
				</div>
				<div class="navbar-collapse">
					<ul class="navbar-right">
						<li>
							<div class="homebtn">
								<a href="#"><span class="text">我的主頁</span></a>
							</div>
						</li>
						<li class="dropdown-btn">
							<a href="#" tabindex="0"><img src="" alt="img"></a>
							<ul class="dropdown-menu">
								<li>
									<a href="#"><span class="text">個人資訊</span></a>
								</li>
								<li>
									<a href="#"><span class="text">登出</span></a>		
								</li>
							</ul>
						</li>
					</ul>
				</div>
			</div>
		</nav>

		<!--橫幅-->
		<div class="banner">
			<div class="container">
				<img src="" alt="img">
					<span class="banner-name test-name text-bold"></span>
					<span class="banner-extInfo course-name"></span>
			</div>
		</div>
		<!--下半部分-->
		<div class="lowerhalf">
			<div class="container">
				<!--左下的選單-->
				<div class="test-sidebar-container">
					<div class="test-sidebar">
						<ul class="test-sidebar-menu">
							<li>
								<a href="test.html?" id="handin_test_btn"><span class="text-bold">確認交卷</span></a>
							</li>
						</ul>
						
					</div>
				</div>
			<!--右下區域-->
				<div class="content-right">
					<form>
						<div id="question"></div>
						<br><br><br>
						<input type="submit" class="submit-btn round-border" value="確認">
					</form>
				</div>
				
			</div>
		</div>
		
		
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
		<script>//////////////////////離開提示
			$(window).bind('beforeunload',function(){
				return '即將交卷，確認繼續?';
			});
		</script>
		<script>
///////////////////從URL接收參數///////////////////////////
function getValue(varname)
{
  var url = window.location.href;
  var qparts = url.split("?");
  if (qparts.length == 0){return "";}
  var query = qparts[1];
  var vars = query.split("&amp;");
  var value = "";
  for (i=0; i<vars.length; i++)
  {
    var parts = vars[i].split("=");
    if (parts[0] == varname)
    {
      value = parts[1];
      break;
    }
  }
  value = unescape(value);
  value.replace(/\+/g," ");
  return value;
}

var questionid = getValue("questionid");
var testid = getValue("testid");
var userid = getValue("userid");
//////////////在URL後加上參數///////////
let sidebar_url = '';
let btn_url = 'userid='+userid+'&courseid='+courseid+'&testid='+testid;
appendURL('#handin_test_btn', btn_url);

//////////////在url後加字串/////////
function appendURL(selector, str){
	$(selector).attr('href', $(selector).attr('href')+str);
}
////////////////載入左邊選單////////
$.ajax({
	type: "GET",
	url: "api/Question.do",
	data: "TestId="+testid,
	crossDomain: true,
	cache: false,
	dataType: 'json',
	timeout: 5000,
	success: function (response) {
		if(response.status == 200){
			updateSidebar(response.response.data);
		}
	},
	error: function () {
		alert("無法連線到伺服器！");
	}
});




function updateSidebar(data) {
	var sidebar_list = '';
	$.each(data, function(index, value) {
		sidebar_list += '<li>';
		sidebar_list += '<a href="answeringTest.html?questionid=' + (value['id']+1) + '">' ;
		sidebar_list += '<span>第' + (value['id']+1) + '題</span>';
		sidebar_list += '</a>' ;
		sidebar_list += '</li>';
	})

	$(".test-sidebar-menu").append(sidebar_list);
}

////////////////////////載入題目//////////////////////////

$.ajax({
	url: "api/Question.do",  
	type: "GET",
	data: {"QuestionId":questionid, "TestId":testid},
	dataType:"json",
	crossDomain: true,
	cache: false,
	timeout: 5000,
	success: function (response) {
		if(response.status == 200){
			updateHtml(response.response.data);
		}
    },
	error: function () {
		console.log("請求失敗");
	}

});
function updateHtml(data) {
	var div_html = '';
	div_html += '<span>' + data['text'] + '</span>' ;//題目內容
	num = 0;
	if(data['answerA']!=null){ num += 1; }
	if(data['answerB']!=null){ num += 1; }
	if(data['answerC']!=null){ num += 1; }
	if(data['answerD']!=null){ num += 1; }
	switch(num){
		case 0: //簡答題
			div_html += '<textarea class="essay round-border blue-border" rows="6"></textarea>';
			break;
			
		case 1: //單選題
			div_html += '<ul class="choice-list">';
			div_html += '<li><input type="radio" class="choice_1"  name="1" data="1"><span class="choice-text">'+data["optionA"]+'</span></li>';
			div_html += '<li><input type="radio" class="choice_2"  name="1" data="1"><span class="choice-text">'+data["optionB"]+'</span></li>';
			div_html += '<li><input type="radio" class="choice_3"  name="1" data="1"><span class="choice-text">'+data["optionC"]+'</span></li>';
			div_html += '<li><input type="radio" class="choice_4"  name="1" data="1"><span class="choice-text">'+data["optionD"]+'</span></li>';
			div_html += '</ul>';
			break;
			
		case 2: //多選題
		case 3:
		case 4:
			div_html += '<ul class="choice-list">';
			div_html += '<li><input type="checkbox" class="choice_1"  name="2" data="1"><span class="choice-text">'+data['optionA']+'</span></li>';
			div_html += '<li><input type="checkbox" class="choice_2"  name="2" data="1"><span class="choice-text">'+data['optionB']+'</span></li>';
			div_html += '<li><input type="checkbox" class="choice_3"  name="2" data="1"><span class="choice-text">'+data['optionC']+'</span></li>';
			div_html += '<li><input type="checkbox" class="choice_4"  name="2" data="1"><span class="choice-text">'+data['optionD']+'</span></li>';
			div_html += '</ul>';
			break;
	}
	$("#question").append(div_html);
}
/////////////////////上傳/////////////////////
$('#submit_btn').click(function(){
	submit();
});
		
function submit() {
	var input_ans_1 = $('.choice_1').val();
	var input_ans_2 = $('.choice_2').val();
	var input_ans_3 = $('.choice_3').val();
	var input_ans_4 = $('.choice_4').val();
	var input_essay = $('.essay').val();
	var handin_ans_1 = '';
	var handin_ans_2 = '';
	var handin_ans_3 = '';
	var handin_ans_4 = '';
	if(input_essay != null){
		handin_ans_1 += input_essay;
	}
	var check1 = $("input[class=choice_1]:checked").val()
	if(check1 == 1){
		handin_ans_1 += input_ans_1;
	}
	var check2 = $("input[class=choice_2]:checked").val()
	if(check2 == 1){
		handin_ans_2 += input_ans_2;
	}
	var check3 = $("input[class=choice_3]:checked").val()
	if(check3 == 1){
		handin_ans_3 += input_ans_3;
	}
	var check4 = $("input[class=choice_4]:checked").val()
	if(check4 == 1){
		handin_ans_4 += input_ans_4;
	}
	
	//將資料轉成JSON格式
	var data_object = {
		"HandInAnswerA":　handin_ans_1,
		"HandInAnswerB":　handin_ans_2,
		"HandInAnswerC":　handin_ans_3,
		"HandInAnswerD":　handin_ans_4,
	};
	//將JSON格式轉成字串
	var data_string = JSON.stringify(data_object);
	//發出POST的AJAX請求
	$.ajax({
		type: "POST",
		url: "api/HandIn.do",
		data: data_string,
		crossDomain: true,
		cache: false,
		dataType: 'json',
		timeout: 5000,
		success: function(response){
			if(response.status == 200){
				console.log("上傳成功!");
			}
		},
		error: function(){
			alert("無法連線到伺服器!");
		}
	});
}


		</script>
		<script src="../../../js_files/general.js"></script>
	</body>
</html>
