<!DOCTYPE html>
<html>
	<head>
		<title>OWL MY CLASS</title>
		<meta charset="utf-8">
		<base href="">
		<link rel="icon" type="image/png" href="">
		<link href="" type="text/css" rel="stylesheet">
		<link href="css_files/general.css" type="text/css" rel="stylesheet">
		<link href="css_files/.css" type="text/css" rel="stylesheet">
	</head>
	<body>
		<!--畫面最上方的橫條navbar-->
		<nav>
			<div class="container">
				<div class="navbar-header">
					<img src="" alt="logo">
					<span class="text">OWL MY CLASS</span>
				</div>
				<div class="navbar-collapse">
					<ul class="navbar-right">
						<li>
							<div class="homebtn">
								<a href="#"><span class="text">我的主頁</span></a>
							</div>
						</li>
						<li class="dropdown-btn">
							<a href="#" tabindex="0"><img src="" alt="img"></a>
							<ul class="dropdown-menu">
								<li>
									<a href="#"><span class="text">個人資訊</span></a>
								</li>
								<li>
									<a href="#"><span class="text">登出</span></a>		
								</li>
							</ul>
						</li>
					</ul>
				</div>
			</div>
		</nav>

		<!--橫幅-->
		<div class="banner">
			<div class="container">
				<img src="" alt="img">
					<span class="banner-name course-name text-bold"></span>
					<span class="banner-extInfo course-code"></span>
			</div>
		</div>

		<!--下半部分-->
		<div class="lowerhalf">
			<div class="container">
				<!--左下的選單-->
				<div class="sidebar">
					<div class="professor">
						<span class="text-bold">教授:</span><span class="text-bold course-professor"></span>
					</div>
					<ul class="sidebar-menu">
						<li>
							<a href="../info/info.html"><span class="text">課程資訊</span></a>
						</li>
						<li class="currentpage">
							<a href="board.html"><span class="text">課程公告</span></a>
						</li>
						<li>
							<a href="../textbook/textbookList.html"><span class="text">課程教材</span></a>
						</li>
						<li>
							<a href="../homework/homeworkList.html"><span class="text">作業</span></a>
						</li>
						<li>
							<a href="../test/testList.html"><span class="text">測驗</span></a>
						</li>
					</ul>
				</div>
				<!--右下區域-->
				<div class="content-right">
					<div class="content-right-title">
						<span class="text-bold">新增公告</span>
					</div>
					<div class="hr"></div>
						<table class="form-tbl">
							<tbody>
								<tr>
									<td class="tr-title"><span class="text-bold">標題</span></td>
									<td><textarea id="board_name" class="round-border blue-border board-name" name="title" placeholder="標題為必填，限50字" maxlength="50"></textarea></td>
								</tr>
								<tr>
									<td class="tr-title"><span class="text-bold">內容</span></td>
									<td><textarea id="board_detail" class="round-border blue-border board-detail" name="description" placeholder="內文為必填" rows="10"></textarea></td>
								</tr>
								<tr>
									<td><span class="text-bold">附件</span></td>
									<td>
										<span class="board--attachmentName"></span>
										<br>
										<input type="file" class="board_attachment" id="ajaxfile" class="cursor-pointer">
									</td>
								</tr>
							</tbody>
						</table>
						<input id="submit" class="submit-btn round-border cursor-pointer" value="確認新增">
				</div>
			</div>
		</div>
		
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
		<script src="js_files/general.js"></script>
		<script>
		var url_string = window.location.href;                
		var url = new URL(url_string);
		console.log(url);
		var courseid = url.searchParams.get("CourseId");
        var boardid;
		//console.log(courseid);
			
            console.log(courseid);
            
            function submit() {
                var name = $('#board_name').val();
                var detail = $('#board_detail').val();
                
                var attachment = "";
                

				if(ajaxfile.files[0] != null){
					attachment =  ajaxfile.files[0]["name"];
				}


                    // 將資料組成JSON格式
                    var data_object = {
                        "BoardName": name,
                        "BoardDetails": detail,
                        "CourseId": courseid,
                        "Attachment": attachment
                    };                    

                    // 將JSON格式轉換成字串
                    var data_string = JSON.stringify(data_object);
                    
                    console.log(attachment);
					
                    // 發出POST的AJAX請求
                    $.ajax({
                            type: "POST",
                            url: "api/BoardController",
                            data: data_string,
                            crossDomain: true,
                            async: false,
                            cache: false,
                            dataType: 'json',
                            timeout: 5000,
                            success: function (response) {
                                console.log(response);
                                if(response.status == 200){
                                  	$.each(response.response.data, function (){
                                  		console.log(this);
                                  		boardid = this.BoardId;
                                  	})    	
                                    //updateSQLTable(response.response);
                                }
                            },
                            error: function () {
                                alert("無法連線到伺服器！");
                            }
                    });
                                                       
            }
            
            
            function uploadfile(){
				console.log(ajaxfile.files[0]);
            	let formData = new FormData();
            	formData.append(boardid, ajaxfile.files[0]);
            	console.log(formData);
            	
            	for (var pair of formData.entries()) {
            	    console.log(pair[0]+ ', ' + pair[1]); 
            	}
            	
        		
        		$.ajax({
                    type: "POST",
                    url: "api/UploadController",
                    data: formData,
                    processData : false, 
                    contentType : false,
                    crossDomain: true,
                    cache: false,
                    timeout: 60000,
                    success: function (response) {
                        console.log(response);
                        if(response.status == 200){
                            //updateSQLTable(response.response);
                            console.log("success");
                            alert("上傳成功");
                        }
                    },
                    error: function (XMLHttpRequest) {
                    	console.log("POST ERROR");
                    	alert("ERROR");
                    	console.log(XMLHttpRequest.status);
                    	console.log(XMLHttpRequest.readyState);
                        alert("無法連線到伺服器！");
                    }
                    
            });
            }
            
           
            $('#submit').click(function() {
            	submit();
            	console.log(boardid);
            	
            });
        
		</script>
	</body>
</html>